# BettaFish Tengine 反向代理配置
# 文件位置：/etc/tengine/conf.d/bettafish.conf

# BettaFish Flask 应用反向代理
location /bettafish/ {
    # 移除路径前缀，转发到后端
    rewrite ^/bettafish/?(.*)$ /$1 break;
    
    # 代理到 Flask 应用
    proxy_pass http://127.0.0.1:5000;
    
    # 基本代理设置
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    
    # WebSocket 支持（SocketIO）
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    
    # 超时设置
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    
    # 缓冲设置
    proxy_buffering off;
    proxy_request_buffering off;
    
    # 禁用缓存（开发环境）
    # proxy_cache off;
}

# Streamlit 子应用代理（如果需要单独访问）
# Query Engine
location /bettafish/query/ {
    rewrite ^/bettafish/query/?(.*)$ /$1 break;
    proxy_pass http://127.0.0.1:8503;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    proxy_buffering off;
}

# Media Engine
location /bettafish/media/ {
    rewrite ^/bettafish/media/?(.*)$ /$1 break;
    proxy_pass http://127.0.0.1:8502;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    proxy_buffering off;
}

# Insight Engine
location /bettafish/insight/ {
    rewrite ^/bettafish/insight/?(.*)$ /$1 break;
    proxy_pass http://127.0.0.1:8501;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_connect_timeout 300s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    proxy_buffering off;
}

